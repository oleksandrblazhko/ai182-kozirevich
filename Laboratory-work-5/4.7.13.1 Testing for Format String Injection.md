## Тестування ін'єкції рядка формату
| ID |
|---|
| WSTG-INPV-13 |
### Короткі відомості
Рядок формату — це послідовність символів із нульовим символом, яка також містить специфікатори перетворення, інтерпретовані або перетворені під час виконання. Якщо код на стороні сервера об’єднує введені користувачем дані з рядком формату, зловмисник може додати додаткові специфікатори перетворення, щоб спричинити помилку виконання, розкриття інформації або переповнення буфера.

Найгірший випадок уразливості рядків формату виникає в мовах, які не перевіряють аргументи, а також містять специфікатор %n, який записує в пам’ять. Ці функції, якщо зловмисник використає їх, змінюючи рядок формату, можуть призвести до розкриття інформації та виконання коду:

C і C++ printf і подібні методи fprintf, sprintf, snprintf
Perl printf і sprintf
Ці функції рядка форматування не можуть записувати в пам’ять, але зловмисники все одно можуть спричинити розкриття інформації, змінивши рядки формату на вихідні значення, які розробники не збиралися надсилати:

Python 2.6 і 2.7 str.format і Python 3 unicode str.format можна змінювати шляхом введення рядків, які можуть вказувати на інші змінні в пам’яті
Наступні функції рядка формату можуть спричинити помилки виконання, якщо зловмисник додає специфікатори перетворення:

Java String.format і PrintStream.format
PHP printf
Шаблон коду, який спричиняє вразливість рядка форматування, — це виклик функції форматування рядка, яка містить несанкціонований ввід користувача. У наступному прикладі показано, як налагодження printf може зробити програму вразливою:

Приклад на C:
```
char *userName = /* введення з контрольованого користувачем поля */;

printf("DEBUG Поточний користувач: ");
// Вразливий код налагодження
printf(ім'я користувача);
```
Приклад на Java:
```
final String userName = /* введення з контрольованого користувачем поля */;

System.out.printf("DEBUG Поточний користувач: ");
// Вразливий код:
System.out.printf(ім'я користувача);
```
У цьому конкретному прикладі, якщо зловмисник встановив для свого імені користувача один або кілька специфікаторів перетворення, це призведе до небажаної поведінки. У прикладі C буде виведено вміст пам’яті, якщо ім’я користувача містить ```%p%p%p%p%p```, і це може пошкодити вміст пам’яті, якщо в рядку є %n. У прикладі Java ім’я користувача, що містить будь-який специфікатор, який потребує введення (включаючи %x або %s), призведе до збою програми з IllegalFormatException. Хоча в прикладах все ще є інші проблеми, уразливість можна усунути за допомогою аргументів printf функції printf("DEBUG Current user: %s", userName).

### Цілі тесту
- Оцініть, чи впровадження специфікаторів перетворення рядка формату в поля, які контролюються користувачем, спричиняє небажану поведінку програми.
### Як тестувати
Тести включають аналіз коду та введення специфікаторів перетворення як введення користувача в тестову програму.

### Статичний аналіз
Інструменти статичного аналізу можуть знаходити вразливі місця форматних рядків у коді або у двійкових файлах. Приклади інструментів:

- C і C++: Flawfinder
- Java: правило FindSecurityBugs FORMAT_STRING_MANIPULATION
- PHP: аналізатор форматування рядків у phpsa
### Ручна перевірка коду
Статичний аналіз може пропустити більш тонкі випадки, зокрема рядки формату, згенеровані складним кодом. Щоб шукати вразливості в кодовій базі вручну, тестувальник може шукати всі виклики в кодовій базі, які приймають рядок формату, і простежити назад, щоб переконатися, що ненадійний вхід не може змінити рядок формату.

### Ін'єкція специфікатора перетворення
Тестувальники можуть перевіряти на рівні модульного або повного системного тестування, надсилаючи специфікатори перетворення в будь-який вхідний рядок. Фазз програму, використовуючи всі специфікатори перетворення для всіх мов, які використовує тестована система. Перегляньте сторінку атаки рядка формату OWASP, щоб дізнатися про можливі вхідні дані для використання. Якщо перевірка не вдається, програма аварійно завершує роботу або видає неочікуваний результат. Якщо тест пройдено, спробу надіслати специфікатор перетворення слід заблокувати, або рядок має пройти через систему без проблем, як і з будь-яким іншим дійсним введенням.

Приклади в наступних підрозділах мають URL-адресу такої форми:

```https://vulnerable_host/userinfo?username=x```

- Контрольоване користувачем значення x (для параметра імені користувача).
### Ручне тестування
Тестувальники можуть виконати тестування вручну за допомогою веб-браузера або інших інструментів налагодження веб-API. Перейдіть до веб-програми або сайту, щоб запит мав специфікатори перетворення. Зауважте, що більшість специфікаторів перетворення потребують кодування, якщо надсилаються всередині URL-адреси, оскільки вони містять спеціальні символи, включаючи % і {. Тест може представити рядок специфікаторів ```%s%s%s%n```, перейшовши за такою URL-адресою:
```https://vulnerable_host/userinfo?username=%25s%25s%25s%25n```

Якщо веб-сайт уразливий, веб-переглядач або інструмент має отримати повідомлення про помилку, яка може включати тайм-аут або код повернення HTTP 500.

Код Java повертає помилку

```java.util.MissingFormatArgumentException: специфікатор формату "%s"```

Залежно від реалізації C, процес може повністю завершитися збоєм із помилкою сегментації.

Фаззінг із допоміжним інструментом
Інструменти Fuzzing, включаючи wfuzz, можуть автоматизувати тестування ін’єкцій. Для wfuzz почніть із текстового файлу (у цьому прикладі fuzz.txt) з одним введенням на рядок:

fuzz.txt:
```
Аліса
%s%s%s%n
%p%p%p%p%p
{event.__init__.__globals__[CONFIG][SECRET_KEY]}
```
Файл fuzz.txt містить наступне:

- Правильний вхід alice для перевірки того, що програма може обробити звичайний вхід
- Два рядки з C-подібними специфікаторами перетворення
- Один специфікатор перетворення Python для спроби читання глобальних змінних
Щоб надіслати вхідний файл фаззингу до веб-програми, що тестується, скористайтеся такою командою:

```wfuzz -c -z файл,fuzz.txt,urlencode https://vulnerable_host/userinfo?username=FUZZ```

У наведеному вище виклику аргумент urlencode забезпечує відповідне екранування для рядків, а FUZZ (з великими літерами) повідомляє інструменту, куди вводити вхідні дані.

Приклад результату виглядає наступним чином
```
ID Відповідь Рядки Слово Символи Корисне навантаження
==================================================== ==================

000000002: 500 0 L 5 W 142 канал "%25s%25s%25s%25n"
000000003: 500 0 L 5 W 137 каналів "%25p%25p%25p%25p%25p"
000000004: 200 0 L 1 W 48 Ch "%7Bevent.__init__.__globals__%5BCONFIG%5D%5BSECRET_KEY%5D%7D"
000000001: 200 0 L 1 W 5 Ch "аліса"
```
Наведений вище результат підтверджує слабкість програми щодо введення C-подібних специфікаторів перетворення %s і %p.
